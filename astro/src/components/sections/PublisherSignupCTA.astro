---
import Button from '@components/common/Button.astro';
import Icon from '@components/common/Icon.astro';
---

<section class="section section-cta" id="partner-form">
  <div class="container">
    <div class="cta-content">
      <div class="cta-text">
        <h2 class="cta-title">let's work together.</h2>
        <p class="cta-subtitle">
          Tell us about your books and let's explore how we can feature them in our boxes.
        </p>
      </div>
      
      <div class="form-container">
        <form class="signup-form" id="publisherSignupForm">
          <!-- Hidden fields -->
          <input type="hidden" name="utm_source" id="pubUtmSource">
          <input type="hidden" name="utm_medium" id="pubUtmMedium">
          <input type="hidden" name="utm_campaign" id="pubUtmCampaign">
          <input type="hidden" name="referrer" id="pubReferrer">
          <input type="hidden" name="mode" value="publisher">
          
          <!-- Honeypot -->
          <div class="form-honeypot" aria-hidden="true">
            <input type="text" name="website" tabindex="-1" autocomplete="off">
          </div>
          
          <!-- Email Field -->
          <div class="form-group">
            <label for="pubEmail">Email <span class="required">*</span></label>
            <input type="email" id="pubEmail" name="email" required placeholder="your@email.com">
            <span class="form-error" id="pubEmailError">
              Oops! We'll need a valid email to keep you in the loop
            </span>
          </div>
          
          <!-- Company Field -->
          <div class="form-group">
            <label for="pubCompany">
              Company / Imprint / Author name <span class="required">*</span>
            </label>
            <input type="text" id="pubCompany" name="company" required placeholder="Your publishing name">
            <span class="form-error" id="pubCompanyError">
              We'd love to know who we're chatting with!
            </span>
          </div>
          
          <!-- Message Field -->
          <div class="form-group">
            <label for="pubMessage">
              Tell us about your books <span class="optional">(optional)</span>
            </label>
            <textarea id="pubMessage" name="message" rows="3" placeholder="What titles are you excited about? What genres do you publish?"></textarea>
          </div>
          
          <!-- Submit -->
          <Button type="submit" variant="primary" size="lg" full>
            <span class="btn-label">Start the Conversation</span>
            <span class="btn-loading-indicator">
              <Icon name="spinner" size={20} class="spinner" />
            </span>
          </Button>
          
          <p class="form-note">
            We'll reach out within a few days to discuss partnership opportunities.
          </p>
        </form>
        
        <!-- Success State -->
        <div class="form-success hidden" id="pubFormSuccess">
          <div class="success-icon">
            <Icon name="check-circle" size={48} />
          </div>
          <h3>thanks for reaching out!</h3>
          <p>We're excited to learn more about your books. We'll be in touch soon to discuss how we can work together.</p>
          <div class="success-share">
            <p>In the meantime, follow us for updates:</p>
            <div class="share-buttons">
              <a href="https://instagram.com/inkblotcrew" class="share-btn" target="_blank">Instagram</a>
              <a href="https://tiktok.com/@inkblotcrew" class="share-btn" target="_blank">TikTok</a>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>

<script>
  const form = document.getElementById('publisherSignupForm') as HTMLFormElement;
  const formSuccess = document.getElementById('pubFormSuccess');
  
  // Capture UTM params
  const urlParams = new URLSearchParams(window.location.search);
  const utmSource = document.getElementById('pubUtmSource') as HTMLInputElement;
  const utmMedium = document.getElementById('pubUtmMedium') as HTMLInputElement;
  const utmCampaign = document.getElementById('pubUtmCampaign') as HTMLInputElement;
  const referrerField = document.getElementById('pubReferrer') as HTMLInputElement;
  
  if (utmSource) utmSource.value = urlParams.get('utm_source') || '';
  if (utmMedium) utmMedium.value = urlParams.get('utm_medium') || '';
  if (utmCampaign) utmCampaign.value = urlParams.get('utm_campaign') || '';
  if (referrerField) referrerField.value = document.referrer || '';
  
  // Form validation
  function isValidEmail(email: string) {
    return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
  }
  
  function validateForm() {
    let isValid = true;
    
    const email = document.getElementById('pubEmail') as HTMLInputElement;
    const emailGroup = email.closest('.form-group');
    if (!email.value || !isValidEmail(email.value)) {
      emailGroup?.classList.add('error');
      isValid = false;
    } else {
      emailGroup?.classList.remove('error');
    }
    
    const company = document.getElementById('pubCompany') as HTMLInputElement;
    const companyGroup = company?.closest('.form-group');
    if (company && company.value.trim() === '') {
      companyGroup?.classList.add('error');
      isValid = false;
    } else {
      companyGroup?.classList.remove('error');
    }
    
    return isValid;
  }
  
  // Form submission
  form?.addEventListener('submit', async (e) => {
    e.preventDefault();
    
    if (!validateForm()) return;
    
    // Check honeypot
    const honeypot = form.querySelector('input[name="website"]') as HTMLInputElement;
    if (honeypot?.value) {
      showSuccess();
      return;
    }
    
    const submitBtn = form.querySelector('button[type="submit"]');
    submitBtn?.classList.add('loading');
    if (submitBtn) (submitBtn as HTMLButtonElement).disabled = true;
    
    try {
      // Simulate API call - replace with actual endpoint
      await new Promise(resolve => setTimeout(resolve, 1500));
      showSuccess();
    } catch (error) {
      console.error('Form submission error:', error);
      alert('Oops! Something went wrong. Please try again.');
    } finally {
      submitBtn?.classList.remove('loading');
      if (submitBtn) (submitBtn as HTMLButtonElement).disabled = false;
    }
  });
  
  function showSuccess() {
    form?.classList.add('hidden');
    formSuccess?.classList.remove('hidden');
    formSuccess?.scrollIntoView({ behavior: 'smooth', block: 'center' });
  }
  
  // Real-time validation
  const emailInput = document.getElementById('pubEmail');
  emailInput?.addEventListener('input', () => {
    emailInput.closest('.form-group')?.classList.remove('error');
  });
  
  const companyInput = document.getElementById('pubCompany');
  companyInput?.addEventListener('input', () => {
    companyInput.closest('.form-group')?.classList.remove('error');
  });
</script>
